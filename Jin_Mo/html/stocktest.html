<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock search</title>
</head>
<body>

  <div id="app">
        <button @click="setSearchYear(1)">1</button>
        <button @click="setSearchYear(3)">3</button>
        <button @click="setSearchYear(5)">5</button>
        <hr>
        <stock-table 
            :earn_values='jsonData.earn_values'
            :req='req'
            :years='searchYear'>
        </stock-table>
    </div>

    <template id="stock-table">
        <div>
            <table border="3">
                <tr>
                    <th colspan="4">{{ year }}</th>
                </tr>
                <tr>
                    <td>名稱</td>
                    <td>編號</td>
                    <td>現金</td>
                    <td>股票</td>
                </tr>
                <tr is='stock-table-body'
                    v-for='(earn_value, index) in earn_values'
                    :key='index'
                    :earn_value='earn_value'
                    :year='years'
                    :req='index'>
                </tr>
            </table>
        </div>
    </template>

    <template id="stock-table-body">
        <tr>
            <td>null</td>
            <td>{{ req }}</td>
            <td>{{ cash }}</td>
            <td>{{ stock }}</td>
        </tr>
    </template>

    <script src="https://unpkg.com/vue@2.6.11/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        Vue.component('stock-table-body', {
            props: {
                req: '',
                year: {},
                earn_value: {}
            },
            template: '#stock-table-body',
            computed: {
                cash() {
                    let len = this.year.length;
                    let cash_avg = null;
                    if (len <= 1) {
                        return this.earn_value[this.year[0]]['cash'];
                    } else {
                        let sum = 0;
                        for (i=0; i<len; i++) {
                            sum += this.earn_value[this.year[i]]['cash'];
                        }
                        return (sum / len).toFixed(2);
                    }
                },
                stock() {
                    let len = this.year.length;
                    let stock_avg = null;
                    if (len <= 1) {
                        return this.earn_value[this.year[0]]['stock'];
                    } else {
                        let sum = 0;
                        for (i=0; i<len; i++) {
                            sum += this.earn_value[this.year[i]]['stock'];
                        }
                        return (sum / len).toFixed(2);
                    }
                }
            }
        });

        Vue.component('stock-table', {
            props: {
                req: {},
                years: {},
                earn_values: {}
            },
            template: '#stock-table',
            computed: {
                year() {
                    if (this.years.length <= 1) {
                        return this.years[0];
                    } else {
                        let len = this.years.length;
                        return this.years[0] + '~' + this.years[len - 1];
                    }
                }
            }
        });
        
        new Vue({
            el: '#app',
            data: {
                jsonData: null,
                req: null,
                years: null,
                searchYear: []
            },
            created() {
                console.log('created');
                this.getStockData();
            },
            mounted() {
                console.log('mounted');
            },
            watch: {
                jsonData: function() {
                    this.getReq();
                    this.getYear();
                    this.getSearchYear();
                }
            },
            methods: {
                setSearchYear(value) {
                    console.log(value);
                    this.searchYear = [];
                    for (i = 0; i < value; i++) {
                        this.searchYear.push(this.years[i]);
                    }
                    this.searchYear.reverse();
                    console.log('searchYear', this.searchYear);
                },
                getSearchYear() {
                    this.searchYear.push(this.years[0]);
                },
                getYear() {
                    this.years = Object.keys(this.jsonData.earn_values[this.req[0]]);
                    console.log('getYear', this.years);
                    console.log('reverse year', this.years.reverse());
                },
                getReq() {
                    // this.req = this.jsonData.req['stock_index_arys'];
                    // this.req = Object.values(this.jsonData.req.stock_index_arys);
                    this.req = Object.keys(this.jsonData.earn_values);
                    console.log('getReq', this.req);
                },
                replaceData(data) {
                    data = JSON.stringify(data);
                    data = data.replace(/\:\"\[/, '\:\[');
                    data = data.replace(/\"\]\"/, '\"\]');
                    data = data.replace(/\:\"\{/g, '\:\{');
                    data = data.replace(/\}\}\"/g, '\}\}');
                    data = data.replace(/\\/g, '');
                    return JSON.parse(data);
                },
                getStockData() {
                    axios.get('/tw_stock_earn_values/', {
                        baseURL: 'https://cors-anywhere.herokuapp.com/http://trading.maxosoft.com/api/',
                        params: {
                            stock_index_arys: '[\"0050\",\"2002\"]'
                        }
                    })
                    .then((response) => {
                        console.log(response);
                        console.log(this.replaceData(response.data));
                        this.jsonData = this.replaceData(response.data);
                    })
                    .catch((err) => {
                        console.log(err);
                    });
                }
            }
        });
    </script>
</body>
</html>